id: 302-portfolio-rebalancing
description: Dynamic portfolio rebalancing - Agent analyzes current holdings, calculates optimal allocation between SOL and USDC based on market conditions, and executes rebalancing trades through Jupiter.
tags:
  [
    "dynamic",
    "rebalancing",
    "portfolio",
    "jupiter",
    "market-analysis",
    "risk-management",
  ]

initial_state:
  # User's main wallet with mixed holdings
  - pubkey: "USER_WALLET_PUBKEY"
    owner: "11111111111111111111111111111111"
    lamports: 3000000000 # 3 SOL

  # User's USDC position - substantial amount for rebalancing
  - pubkey: "USER_USDC_ATA"
    owner: "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"
    lamports: 2039280
    data:
      mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
      owner: "USER_WALLET_PUBKEY"
      amount: "150000000" # 150 USDC

prompt: "I want to rebalance my portfolio based on current market conditions. Please analyze my current holdings (SOL and USDC), check current market prices and Jupiter lending rates, then execute optimal rebalancing to maximize returns while maintaining some liquidity. I'm comfortable with moderate risk and want to optimize for yield."

ground_truth:
  min_score: 0.7

  final_state_assertions:
    # SOL balance should change based on rebalancing decision
    - type: SolBalanceChange
      pubkey: "USER_WALLET_PUBKEY"
      # Should either increase (selling USDC for SOL) or decrease (selling SOL for USDC)
      expected_change_not_zero: true
      weight: 0.25

    # USDC balance should be rebalanced
    - type: TokenAccountBalanceChange
      pubkey: "USER_USDC_ATA"
      expected_change_not_zero: true
      weight: 0.25

    # Should have some lending position if yield is optimal
    - type: JupiterLendingPosition
      pubkey: "USER_WALLET_PUBKEY"
      mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
      expected_gte: 10000000 # At least 10 USDC in lending if optimal
      weight: 0.25

    # Total portfolio value should increase or be optimized
    - type: TotalPortfolioValue
      pubkey: "USER_WALLET_PUBKEY"
      expected_gte: 250000000 # At least maintain or increase portfolio value
      weight: 0.25

  expected_tool_calls:
    - tool_name: "account_balance"
      description: "Check current wallet balances and positions"
      critical: false
      expected_params: ["wallet_pubkey"]
      weight: 0.15

    - tool_name: "jupiter_swap"
      description: "Execute rebalancing swaps through Jupiter"
      critical: true
      expected_params: ["input_token", "output_token", "amount"]
      weight: 0.25

    - tool_name: "jupiter_lend"
      description: "Deposit USDC into Jupiter lending for yield"
      critical: true
      expected_params: ["mint", "amount"]
      weight: 0.25

    - tool_name: "jupiter_positions"
      description: "Check current and final lending positions"
      critical: false
      expected_params: ["user_pubkey"]
      weight: 0.1

  success_criteria:
    - type: "portfolio_analysis"
      description: "Agent should analyze current holdings and calculate portfolio allocation"
      required: true
      weight: 0.25

    - type: "market_conditions_assessment"
      description: "Agent should check current prices and lending rates via tools"
      required: true
      weight: 0.25

    - type: "rebalancing_execution"
      description: "Execute trades to achieve optimal portfolio allocation"
      required: true
      weight: 0.25

    - type: "risk_management"
      description: "Maintain appropriate liquidity and manage risk levels"
      required: true
      weight: 0.25

  expected_data_structure:
    - path: "$.result.data.current_portfolio"
      type: "object"
      required_fields: ["sol_balance", "usdc_balance", "total_value_usd"]
      weight: 0.15

    - path: "$.result.data.market_analysis"
      type: "object"
      required_fields: ["sol_price", "usdc_rate", "recommended_allocation"]
      weight: 0.15

    - path: "$.result.data.rebalancing_plan"
      type: "array"
      min_items: 1
      weight: 0.2

    - path: "$.result.data.execution_steps"
      type: "array"
      min_items: 1
      weight: 0.2

    - path: "$.result.data.tool_calls"
      type: "array"
      min_items: 3
      required_fields: ["tool_name", "parameters", "success"]
      weight: 0.2

  expected_flow_complexity:
    - type: "multi_step_execution"
      description: "Should execute portfolio analysis â†’ rebalancing sequence"
      min_steps: 3
      weight: 0.3

    - type: "context_awareness"
      description: "Should analyze current holdings for rebalancing decisions"
      required: true
      weight: 0.3

    - type: "strategic_planning"
      description: "Should plan optimal allocation based on market conditions"
      required: true
      weight: 0.4

  expected_otel_tracking:
    - type: "tool_call_logging"
      description: "OpenTelemetry should track all rebalancing tool calls"
      required_tools:
        ["account_balance", "jupiter_swap", "jupiter_lend", "jupiter_positions"]
      weight: 0.3

    - type: "execution_tracing"
      description: "Flow execution should be traceable end-to-end"
      required_spans:
        ["prompt_processing", "portfolio_analysis", "rebalancing_execution"]
      weight: 0.3

    - type: "mermaid_generation"
      description: "Should generate flow diagram from rebalancing sequence"
      required: true
      weight: 0.2

    - type: "performance_metrics"
      description: "Should track execution time and decision metrics"
      required_metrics:
        ["execution_time_ms", "tool_call_count", "rebalancing_efficiency"]
      weight: 0.2

  recovery_expectations:
    - type: "market_analysis_failure_recovery"
      description: "Should recover from failed market analysis with cached data"
      required: true
      weight: 0.2

    - type: "swap_failure_recovery"
      description: "Should recover from failed rebalancing swap with alternative amounts"
      required: true
      weight: 0.2

    - type: "atomic_execution"
      description: "Portfolio rebalancing should execute atomically"
      required: true
      weight: 0.3

    - type: "partial_success_handling"
      description: "Should handle partial rebalancing gracefully"
      required: true
      weight: 0.3
