id: 116-jup-lend-redeem-usdc
description: Mint then redeem jUSDC lending position using Jupiter
tags: ["jupiter", "lend", "mint", "redeem", "yield", "jtoken"]

initial_state:
  # User's main wallet with 5 SOL for transaction fees.
  - pubkey: "USER_WALLET_PUBKEY"
    owner: "11111111111111111111111111111111" # System Program
    lamports: 5000000000 # 5 SOL

  # User's USDC token account with initial balance to mint into lending.
  - pubkey: "USER_USDC_ATA_PLACEHOLDER"
    owner: "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA" # SPL Token Program
    lamports: 2039280 # Rent-exempt minimum
    data:
      mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v" # USDC Mint
      owner: "USER_WALLET_PUBKEY"
      amount: "100000000" # 100 USDC (to have enough for both mint and redeem)

  # A dummy recipient, sometimes required by test setup helpers.
  - pubkey: "RECIPIENT_WALLET_PUBKEY"
    owner: "11111111111111111111111111111111"
    lamports: 0

prompt: "I want to test the full Jupiter lending cycle. First help me mint 50 USDC worth of jUSDC tokens, then redeem those jUSDC tokens back to USDC."

flow:
  - step: 1
    description: "Mint 50 USDC into Jupiter lending to get jUSDC tokens"
    prompt: "I want to mint 50 USDC into Jupiter lending to get jUSDC tokens and start earning yield."
    critical: true
    timeout: 30

  - step: 2
    description: "Redeem jUSDC tokens back to USDC"
    prompt: "I want to redeem my jUSDC tokens back to USDC. Please redeem all jUSDC tokens from my Jupiter lending position."
    depends_on: ["step_1_result"]
    critical: true
    timeout: 30

ground_truth:
  min_score: 0.6

  final_state_assertions:
    # After the full cycle (mint then redeem), the user's jUSDC balance should be effectively zero.
    - type: TokenAccountBalance
      pubkey: "UNUSED_PLACEHOLDER"
      address_derivation:
        type: AssociatedTokenAccount
        owner: "USER_WALLET_PUBKEY"
        mint: "9BEcn9aPEmhSPbPQeFGjidRiEKki46fVQDyPpSQXPA2D" # Jupiter jUSDC Mint
      expected: 0
      weight: 0.3

    # The user's USDC balance should be close to the original amount minus fees/slippage.
    # Should have ~50 USDC from redemption, but lose some to fees and slippage.
    - type: TokenAccountBalance
      pubkey: "UNUSED_PLACEHOLDER"
      address_derivation:
        type: AssociatedTokenAccount
        owner: "USER_WALLET_PUBKEY"
        mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v" # USDC Mint
      expected_gte: 48000000 # At least 48 USDC (allowing for fees/slippage)
      weight: 0.4

  success_criteria:
    - type: "steps_completed"
      description: "Both mint and redeem steps must be completed successfully"
      required: 2
      weight: 0.5

    - type: "no_critical_errors"
      description: "No errors in critical steps"
      required: true
      weight: 0.3

    - type: "final_balance_positive"
      description: "User should end with positive USDC balance"
      required: true
      weight: 0.2
