id: 303-risk-adjusted-growth
description: Dynamic risk-adjusted growth strategy - Agent implements capital preservation with growth, using 30% of SOL for controlled USDC exposure and Jupiter lending with conservative parameters.
tags:
  [
    "dynamic",
    "risk-management",
    "capital-preservation",
    "jupiter",
    "conservative",
    "growth",
  ]

initial_state:
  # User's main wallet - portfolio requiring preservation focus
  - pubkey: "USER_WALLET_PUBKEY"
    owner: "11111111111111111111111111111111"
    lamports: 6000000000 # 6 SOL

  # User's existing USDC position for risk assessment
  - pubkey: "USER_USDC_ATA"
    owner: "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"
    lamports: 2039280
    data:
      mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
      owner: "USER_WALLET_PUBKEY"
      amount: "50000000" # 50 USDC existing

prompt: "I want to implement a risk-adjusted growth strategy using 30% of my SOL. Please preserve most of my capital while generating some yield through conservative Jupiter lending. Analyze current market conditions and implement a strategy that prioritizes capital preservation with moderate growth. Keep enough SOL for transaction fees and emergencies."

ground_truth:
  min_score: 0.75

  final_state_assertions:
    # Should preserve ~70% of SOL (4.2 SOL remaining)
    - type: SolBalanceChange
      pubkey: "USER_WALLET_PUBKEY"
      expected_change_lte: -180500000 # Should not use more than 30% (~1.8 SOL + fees)
      weight: 0.35

    # Should increase USDC position conservatively
    - type: TokenAccountBalance
      pubkey: "USER_USDC_ATA"
      expected_gte: 70000000 # At least 70 USDC total (50 existing + ~20 from swap)
      expected_lte: 90000000 # Not too aggressive, max ~90 USDC
      weight: 0.3

    # Balance after conservative lending
    - type: TokenAccountBalance
      pubkey: "USER_USDC_ATA"
      mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
      expected_gte: 50000000 # Should have at least 50 USDC remaining
      expected_lte: 70000000 # Should be <= 70 USDC after conservative lending
      weight: 0.125

    # Balance deduction validation - proves conservative lending occurred
    - type: TokenAccountBalance
      pubkey: "USER_USDC_ATA"
      mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
      expected_lte: 65000000 # Should be less than maximum acquired (proves conservative lending)
      weight: 0.125

    # Should maintain liquidity buffer
    - type: SolBalance
      pubkey: "USER_WALLET_PUBKEY"
      expected_gte: 3500000000 # At least 3.5 SOL for fees/emergencies
      weight: 0.1

  expected_tool_calls:
    - tool_name: "get_account_balance"
      description: "Check current wallet balances and assess total portfolio"
      critical: false
      expected_params: ["wallet_pubkey"]
      weight: 0.15

    - tool_name: "jupiter_swap"
      description: "Swap 30% of SOL to USDC for conservative growth"
      critical: true
      expected_params: ["input_token", "output_token", "amount"]
      weight: 0.3

    - tool_name: "jupiter_lend_earn_deposit"
      description: "Deposit USDC into Jupiter lending with conservative parameters"
      critical: true
      expected_params: ["mint", "amount"]
      weight: 0.3

  success_criteria:
    - type: "risk_assessment"
      description: "Agent should assess risk tolerance and implement conservative strategy"
      required: true
      weight: 0.25

    - type: "percentage_discipline"
      description: "Correctly calculate and use exactly 30% of SOL balance"
      required: true
      weight: 0.2

    - type: "capital_preservation"
      description: "Maintain majority of SOL for liquidity and emergencies"
      required: true
      weight: 0.25

    - type: "conservative_yield"
      description: "Implement conservative lending strategy with moderate returns"
      required: true
      weight: 0.2

    - type: "market_analysis"
      description: "Analyze current conditions for informed decision-making"
      required: true
      weight: 0.1

  expected_data_structure:
    - path: "$.result.data.risk_analysis"
      type: "object"
      required_fields:
        ["risk_tolerance", "capital_preservation_ratio", "growth_target"]
      weight: 0.15

    - path: "$.result.data.portfolio_allocation"
      type: "object"
      required_fields:
        ["sol_percentage", "usdc_percentage", "lending_percentage"]
      weight: 0.15

    - path: "$.result.data.growth_strategy"
      type: "object"
      required_fields: ["swap_amount", "lend_amount", "liquidity_buffer"]
      weight: 0.15

    - path: "$.result.data.execution_plan"
      type: "array"
      min_items: 2
      weight: 0.15

    - path: "$.result.data.market_conditions"
      type: "object"
      required_fields:
        ["price_volatility", "lending_rates", "recommended_approach"]
      weight: 0.1

    - path: "$.result.data.tool_calls"
      type: "array"
      min_items: 3
      required_fields: ["tool_name", "parameters", "success"]
      weight: 0.15

  expected_flow_complexity:
    - type: "multi_step_execution"
      description: "Should execute risk analysis → conservative swap → lend sequence"
      min_steps: 3
      weight: 0.3

    - type: "context_awareness"
      description: "Should analyze portfolio for risk assessment"
      required: true
      weight: 0.3

    - type: "strategic_planning"
      description: "Should plan conservative growth with capital preservation"
      required: true
      weight: 0.4

  expected_otel_tracking:
    - type: "tool_call_logging"
      description: "OpenTelemetry should track all risk-adjusted growth tool calls"
      required_tools:
        ["get_account_balance", "jupiter_swap", "jupiter_lend_earn_deposit"]
      weight: 0.3

    - type: "execution_tracing"
      description: "Flow execution should be traceable end-to-end"
      required_spans:
        ["prompt_processing", "risk_analysis", "conservative_execution"]
      weight: 0.3

    - type: "mermaid_generation"
      description: "Should generate flow diagram from risk-aware sequence"
      required: true
      weight: 0.2

    - type: "performance_metrics"
      description: "Should track execution time and risk metrics"
      required_metrics:
        ["execution_time_ms", "tool_call_count", "capital_preservation_ratio"]
      weight: 0.2

  recovery_expectations:
    - type: "risk_analysis_failure_recovery"
      description: "Should recover from failed risk analysis with conservative defaults"
      required: true
      weight: 0.2

    - type: "conservative_swap_failure_recovery"
      description: "Should recover from failed swap with smaller amounts"
      required: true
      weight: 0.2

    - type: "atomic_execution"
      description: "Risk-adjusted growth should execute atomically"
      required: true
      weight: 0.3

    - type: "capital_preservation_priority"
      description: "Should prioritize capital preservation over growth"
      required: true
      weight: 0.3
