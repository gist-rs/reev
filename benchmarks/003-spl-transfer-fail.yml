id: 003-spl-transfer-fail
description: Tests an agent's ability to generate a correct instruction when the transaction is guaranteed to fail due to environmental constraints (insufficient funds). A high score is achieved by generating a perfect instruction (~75%), despite the on-chain execution failing (0%).
tags: ["spl-token", "transfer", "usdc", "fail", "surfpool"]

initial_state:
  # User's main wallet with SOL for transaction fees.
  - pubkey: "USER_WALLET_PUBKEY"
    owner: "11111111111111111111111111111111" # System Program
    lamports: 1000000000 # 1 SOL

  # Recipient's main wallet.
  - pubkey: "RECIPIENT_WALLET_PUBKEY"
    owner: "11111111111111111111111111111111" # System Program
    lamports: 1000000000 # 1 SOL

  # User's Associated Token Account (ATA) for REAL USDC, with insufficient funds for the prompt.
  - pubkey: "USER_USDC_ATA"
    owner: "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA" # Token Program
    lamports: 2039280 # Rent
    data:
      mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
      owner: "USER_WALLET_PUBKEY"
      amount: "10000000" # 10 USDC

  # Recipient's Associated Token Account (ATA) for REAL USDC.
  - pubkey: "RECIPIENT_USDC_ATA"
    owner: "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA" # Token Program
    lamports: 2039280 # Rent
    data:
      mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
      owner: "RECIPIENT_WALLET_PUBKEY"
      amount: "0"

prompt: "Please send 15 USDC from my token account (USER_USDC_ATA) to the recipient's token account (RECIPIENT_USDC_ATA). I am the authority (USER_WALLET_PUBKEY)."

ground_truth:
  final_state_assertions:
    # DIAGNOSTIC ONLY: Transaction should fail, so balances should be unchanged.
    - type: TokenAccountBalance
      pubkey: "USER_USDC_ATA"
      expected: 10000000
      weight: 1.0
    - type: TokenAccountBalance
      pubkey: "RECIPIENT_USDC_ATA"
      expected: 0
      weight: 1.0

  expected_instructions:
    - program_id: "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"
      program_id_weight: 1.0
      accounts:
        - pubkey: "USER_USDC_ATA"
          is_signer: false
          is_writable: true
          weight: 1.0
        - pubkey: "RECIPIENT_USDC_ATA"
          is_signer: false
          is_writable: true
          weight: 1.0
        - pubkey: "USER_WALLET_PUBKEY"
          is_signer: true
          is_writable: false
          weight: 1.0
      data: "..."
      data_weight: 0.0
