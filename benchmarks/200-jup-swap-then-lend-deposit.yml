id: 200-jup-swap-then-lend-deposit
description: Multi-step flow - User swaps SOL to USDC then deposits USDC into Jupiter lending.
tags: ["jupiter", "swap", "lend", "multi-step", "flow", "yield"]

initial_state:
  - pubkey: "USER_WALLET_PUBKEY"
    owner: "11111111111111111111111111111111"
    lamports: 5000000000

  - pubkey: "USER_USDC_ATA"
    owner: "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"
    lamports: 2039280
    data:
      mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
      owner: "USER_WALLET_PUBKEY"
      amount: "0"

prompt: "I want to earn yield on my SOL by converting it to USDC and depositing into Jupiter lending. Can you help me swap 2.0 SOL to USDC and then deposit the USDC into Jupiter lending?"

flow:
  - step: 1
    description: "Swap 2.0 SOL to USDC using Jupiter"
    prompt: "I want to swap 2.0 SOL for USDC using Jupiter."
    critical: true
    timeout: 30

  - step: 2
    description: "Deposit received USDC into Jupiter lending"
    prompt: "I want to deposit all the USDC I received from the swap into Jupiter lending to start earning yield. Please deposit the full USDC balance available in my USDC account."
    depends_on: ["step_1_result"]
    critical: true
    timeout: 30

ground_truth:
  min_score: 0.6

  final_state_assertions:
    - type: SolBalance
      pubkey: "USER_WALLET_PUBKEY"
      expected: 1500000000
      weight: 0.3

    - type: TokenAccountBalance
      pubkey: "USER_USDC_ATA_PLACEHOLDER"
      mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
      expected: 50000000
      weight: 0.4

    # - type: JupiterLendingPosition
    #   pubkey: "USER_WALLET_PUBKEY"
    #   mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
    #   expected_approx: 50000000
    #   weight: 0.3

  # expected_instructions:
  #   - step: 1
  #     program_id: "JUP6LkbZbjS1jKKwapdHNy74zcZ3tLUZoi5QNyVTaV4"
  #     instruction_count_range: [4, 8]
  #     weight: 0.5
  #     critical: true

  #   - step: 2
  #     program_id: "jup3YeL8QhtSx1e253b2FDvsMNC87fDrgQZivbrndc9"
  #     instruction_count: 1
  #     weight: 0.5
  #     critical: true

  success_criteria:
    - type: "steps_completed"
      description: "All critical steps must be completed successfully"
      required: 2
      weight: 0.5

    - type: "final_balance_positive"
      description: "User should end with more tokens than started"
      required: true
      weight: 0.3

    - type: "no_critical_errors"
      description: "No errors in critical steps"
      required: true
      weight: 0.2
