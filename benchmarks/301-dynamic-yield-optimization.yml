id: 301-dynamic-yield-optimization
description: Dynamic flow optimization - Agent analyzes wallet, finds best yield strategy using 50% of SOL to maximize USDC returns through Jupiter lending with current market rates.
tags:
  ["dynamic", "yield", "optimization", "jupiter", "percentages", "ai-decision"]

initial_state:
  # User's main wallet with substantial SOL for optimization
  - pubkey: "USER_WALLET_PUBKEY"
    owner: "11111111111111111111111111111111"
    lamports: 8000000000 # 8 SOL

  # User's existing USDC position (smaller amount)
  - pubkey: "USER_USDC_ATA"
    owner: "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"
    lamports: 2039280
    data:
      mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
      owner: "USER_WALLET_PUBKEY"
      amount: "25000000" # 25 USDC existing

prompt: "Use my 50% SOL to maximize my USDC returns through Jupiter lending. Please check current market rates, calculate optimal strategy, and execute the best yield approach for my remaining portfolio. I want to maximize my USD value while managing risk appropriately."

ground_truth:
  min_score: 0.7

  final_state_assertions:
    # Should have approximately 4 SOL remaining (50% used + fees)
    - type: SolBalanceChange
      pubkey: "USER_WALLET_PUBKEY"
      expected_change_gte: -400500000 # Approx 4 SOL + fees
      weight: 0.3

    # Should have significantly more USDC (existing 25M + new from 4 SOL)
    - type: TokenAccountBalance
      pubkey: "USER_USDC_ATA"
      expected_gte: 85000000 # ~85 USDC total (25 existing + ~60 from swap)
      weight: 0.4

    # Should have jUSDC lending position if optimal
    - type: JupiterLendingPosition
      pubkey: "USER_WALLET_PUBKEY"
      mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
      expected_gte: 40000000 # ~40 USDC in lending
      weight: 0.3

  expected_tool_calls:
    - tool_name: "account_balance"
      description: "Check current wallet balances and positions"
      critical: false
      weight: 0.1

    - tool_name: "jupiter_swap"
      description: "Swap SOL to USDC using Jupiter"
      critical: true
      expected_params: ["input_token", "output_token", "amount"]
      weight: 0.4

    - tool_name: "jupiter_lend"
      description: "Deposit USDC into Jupiter lending for yield"
      critical: true
      expected_params: ["mint", "amount"]
      weight: 0.4

    - tool_name: "jupiter_positions"
      description: "Check final lending positions"
      critical: false
      weight: 0.1

  success_criteria:
    - type: "context_resolution"
      description: "Agent should resolve wallet context and current market rates"
      required: true
      weight: 0.2

    - type: "percentage_calculation"
      description: "Correctly calculate and use 50% of SOL balance"
      required: true
      weight: 0.2

    - type: "yield_optimization"
      description: "Agent should analyze yield options and choose optimal strategy"
      required: true
      weight: 0.3

    - type: "multi_step_execution"
      description: "Execute swap and lending operations in correct sequence"
      required: true
      weight: 0.3

  expected_data_structure:
    - path: "$.result.data.wallet_context"
      type: "object"
      required_fields: ["sol_balance", "usdc_balance", "total_portfolio_value"]
      weight: 0.1

    - path: "$.result.data.swap_execution"
      type: "object"
      required_fields: ["input_amount", "output_amount", "exchange_rate"]
      weight: 0.2

    - path: "$.result.data.lend_execution"
      type: "object"
      required_fields: ["deposit_amount", "expected_yield", "apy_rate"]
      weight: 0.2

    - path: "$.result.data.optimization_strategy"
      type: "object"
      required_fields:
        ["target_percentage", "optimal_allocation", "expected_return"]
      weight: 0.2

    - path: "$.result.data.tool_calls"
      type: "array"
      min_items: 2
      required_fields: ["tool_name", "parameters", "success"]
      weight: 0.2

  expected_flow_complexity:
    - type: "multi_step_execution"
      description: "Should execute swap → lend → optimization sequence"
      min_steps: 2
      weight: 0.3

    - type: "context_awareness"
      description: "Should analyze wallet context for yield optimization"
      required: true
      weight: 0.3

    - type: "strategic_planning"
      description: "Should plan optimal yield strategy based on market rates"
      required: true
      weight: 0.4

  expected_otel_tracking:
    - type: "tool_call_logging"
      description: "OpenTelemetry should track all yield optimization tool calls"
      required_tools:
        ["account_balance", "jupiter_swap", "jupiter_lend", "jupiter_positions"]
      weight: 0.3

    - type: "execution_tracing"
      description: "Flow execution should be traceable end-to-end"
      required_spans:
        [
          "prompt_processing",
          "yield_analysis",
          "swap_execution",
          "lend_execution",
        ]
      weight: 0.3

    - type: "mermaid_generation"
      description: "Should generate flow diagram from yield optimization sequence"
      required: true
      weight: 0.2

    - type: "performance_metrics"
      description: "Should track execution time and yield metrics"
      required_metrics:
        ["execution_time_ms", "tool_call_count", "yield_optimization_score"]
      weight: 0.2

  recovery_expectations:
    - type: "market_analysis_failure_recovery"
      description: "Should recover from failed market analysis with cached rates"
      required: true
      weight: 0.2

    - type: "swap_failure_recovery"
      description: "Should recover from failed swap with alternative amounts"
      required: true
      weight: 0.2

    - type: "atomic_execution"
      description: "Yield optimization should execute atomically"
      required: true
      weight: 0.3

    - type: "optimization_fallback"
      description: "Should fallback to simpler strategy if complex optimization fails"
      required: true
      weight: 0.3
